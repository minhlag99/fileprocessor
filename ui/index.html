<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Management System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .admin-alert {
            background-color: #f8d7da;
            color: #721c24;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
            border-radius: 0.25rem;
        }
        .admin-alert-icon {
            margin-right: 0.5rem;
            font-weight: bold;
        }
        .provider-config {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        .preview-container {
            max-width: 100%;
            max-height: 300px;
            overflow: auto;
            margin-top: 1rem;
            border: 1px solid #dee2e6;
            padding: 1rem;
        }
        .preview-image {
            max-width: 100%;
            max-height: 280px;
        }
        .file-item {
            cursor: pointer;
        }
        #filePreview {
            display: none;
        }
        /* New styles for real-time processing visualization */
        .processing-status {
            display: none;
            margin-top: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
        }
        .progress {
            height: 1.5rem;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .step {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .step.active {
            background-color: #0d6efd;
            color: white;
        }
        .step.completed {
            background-color: #198754;
            color: white;
        }
        .step-line {
            flex: 1;
            height: 3px;
            background-color: #e9ecef;
            margin: 1rem 0.5rem;
        }
        .step-line.active {
            background-color: #0d6efd;
        }
        .step-label {
            position: absolute;
            top: 2.5rem;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.8rem;
        }
        .lan-section {
            margin-top: 2rem;
            display: none;
        }
        #realTimeLog {
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
            margin-top: 1rem;
        }
        .log-entry {
            margin-bottom: 0.25rem;
        }
        .log-time {
            color: #6c757d;
        }
        .log-info {
            color: #0d6efd;
        }
        .log-success {
            color: #198754;
        }
        .log-warning {
            color: #ffc107;
        }
        .log-error {
            color: #dc3545;
        }
        .workflow-visualization {
            width: 100%;
            margin-top: 2rem;
            text-align: center;
        }
        .workflow-visualization img {
            max-width: 100%;
            height: auto;
            border-radius: 0.25rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        /* Enhanced Speedometer styles */
        .speedometer-container {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }
        .speedometer {
            position: relative;
            width: 150px;
            height: 110px; /* Increased height to fit larger value display */
            text-align: center;
            font-family: Arial, sans-serif;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 8px;
            background-color: #f8f9fa;
        }
        .speedometer-title {
            font-size: 0.9rem;
            color: #495057;
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }
        .speedometer-dial {
            position: relative;
            width: 120px;
            height: 10px;
            background: linear-gradient(to right, #198754, #ffc107, #dc3545);
            border-radius: 5px;
            margin: 0 auto;
        }
        .speedometer-needle {
            display: none; /* Hide the needle visual */
        }
        .speedometer-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 15px 0 5px 0;
            color: #0d6efd;
            text-align: center;
        }
        .speedometer-unit {
            font-size: 0.9rem;
            font-weight: normal;
            color: #6c757d;
        }
        /* Auth styles */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .user-profile-card {
            display: none;
        }
        .auth-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        .auth-message {
            margin-bottom: 1rem;
        }
        .auth-buttons {
            margin-top: 1rem;
        }
        .cloud-config-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        .cloud-config-item h6 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- OS-specific privilege notification alert -->
        <div class="row mb-3" id="adminAlertRow">
            <div class="col">
                <div class="admin-alert" id="linuxAdminAlert" style="display: none;">
                    <span class="admin-alert-icon">⚠️</span>
                    On Linux/Unix systems, this application requires sudo privileges to run properly. Please make sure to run the server with sudo when on Linux.
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-8">
                <h1>File Management System</h1>
                <p class="lead">Upload, manage, and process different file types with cloud storage integration</p>
            </div>
            <div class="col-md-4 text-end">
                <!-- User authentication section -->
                <div id="userAuthSection">
                    <div id="loginSection" class="text-end">
                        <button id="loginButton" class="btn btn-outline-primary">
                            <i class="bi bi-google"></i> Sign in with Google
                        </button>
                    </div>
                    
                    <div id="userSection" style="display: none;" class="d-flex align-items-center justify-content-end">
                        <img id="userAvatar" src="" alt="User" class="user-avatar">
                        <div class="dropdown">
                            <button id="userDropdown" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <span id="userName">User</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" id="profileLink">User Profile</a></li>
                                <li><a class="dropdown-item" href="#" id="cloudConfigLink">Cloud Storage Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutLink">Sign Out</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User profile card - shown when user clicks profile link -->
        <div class="row mb-4" id="userProfileCard" style="display: none;">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5>User Profile</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <img id="profileAvatar" src="" alt="User" class="me-3" style="width: 64px; height: 64px; border-radius: 50%;">
                            <div>
                                <h5 id="profileName" class="mb-1">User Name</h5>
                                <p id="profileEmail" class="text-muted mb-0">user@example.com</p>
                                <p id="profileProvider" class="text-muted mb-0">Authentication Provider: Google</p>
                            </div>
                        </div>
                        <hr>
                        <h6>Cloud Storage Settings</h6>
                        <p>Configure your personal cloud storage credentials to securely store and access files.</p>
                        <a href="#" id="manageCloudStorageButton" class="btn btn-primary">Manage Cloud Storage</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cloud Storage Config Card - shown when user clicks cloud storage settings -->
        <div class="row mb-4" id="cloudConfigCard" style="display: none;">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5>Cloud Storage Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            Configure your personal cloud storage credentials. These settings will be securely stored and used when you upload or access your files.
                        </div>
                        
                        <div class="cloud-config-item">
                            <h6>Amazon S3 Configuration</h6>
                            <form id="s3ConfigForm">
                                <div class="mb-3">
                                    <label for="userS3Region" class="form-label">Region</label>
                                    <input type="text" class="form-control" id="userS3Region" placeholder="e.g., us-east-1">
                                </div>
                                <div class="mb-3">
                                    <label for="userS3Bucket" class="form-label">Bucket</label>
                                    <input type="text" class="form-control" id="userS3Bucket" placeholder="Your S3 bucket name">
                                </div>
                                <div class="mb-3">
                                    <label for="userS3AccessKey" class="form-label">Access Key</label>
                                    <input type="text" class="form-control" id="userS3AccessKey" placeholder="AWS access key">
                                </div>
                                <div class="mb-3">
                                    <label for="userS3SecretKey" class="form-label">Secret Key</label>
                                    <input type="password" class="form-control" id="userS3SecretKey" placeholder="AWS secret key" autocomplete="current-password">
                                </div>
                                <div class="mb-3">
                                    <label for="userS3Prefix" class="form-label">Prefix (Optional)</label>
                                    <input type="text" class="form-control" id="userS3Prefix" placeholder="e.g., folder/">
                                </div>
                                <button type="submit" class="btn btn-primary">Save S3 Settings</button>
                            </form>
                        </div>
                        
                        <div class="cloud-config-item">
                            <h6>Google Cloud Storage Configuration</h6>
                            <form id="gcsConfigForm">
                                <div class="mb-3">
                                    <label for="userGcsBucket" class="form-label">Bucket</label>
                                    <input type="text" class="form-control" id="userGcsBucket" placeholder="Your GCS bucket name">
                                </div>
                                <div class="mb-3">
                                    <label for="userGcsCredFile" class="form-label">Credential File Path</label>
                                    <input type="text" class="form-control" id="userGcsCredFile" placeholder="Path to service account JSON file">
                                </div>
                                <div class="mb-3">
                                    <label for="userGcsPrefix" class="form-label">Prefix (Optional)</label>
                                    <input type="text" class="form-control" id="userGcsPrefix" placeholder="e.g., folder/">
                                </div>
                                <button type="submit" class="btn btn-primary">Save GCS Settings</button>
                            </form>
                        </div>
                        
                        <div class="text-end mt-3">
                            <button id="closeCloudConfigButton" class="btn btn-secondary">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow visualization showing the file processing flow -->
        <div class="row mb-4">
            <div class="col">
                <div class="workflow-visualization">
                    <img id="workflowGif" src="/workflow.gif" alt="File Processing Workflow" loading="lazy">
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5>Storage Provider Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Provider</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="providerStatusList">
                                    <tr>
                                        <td colspan="3" class="text-center">Loading provider status...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5>Upload File</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Select File</label>
                                <input type="file" class="form-control" id="fileInput" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="storageType" class="form-label">Storage Provider</label>
                                <select class="form-select" id="storageType">
                                    <option value="local" selected>Local Storage</option>
                                    <option value="s3">Amazon S3</option>
                                    <option value="google">Google Cloud Storage</option>
                                </select>
                            </div>

                            <div id="s3Config" class="provider-config">
                                <h6>Amazon S3 Configuration</h6>
                                <div class="mb-2">
                                    <label for="s3Region" class="form-label">Region</label>
                                    <input type="text" class="form-control" id="s3Region" placeholder="e.g., us-east-1">
                                </div>
                                <div class="mb-2">
                                    <label for="s3Bucket" class="form-label">Bucket</label>
                                    <input type="text" class="form-control" id="s3Bucket" placeholder="Your S3 bucket name">
                                </div>
                                <div class="mb-2">
                                    <label for="s3AccessKey" class="form-label">Access Key</label>
                                    <input type="text" class="form-control" id="s3AccessKey" placeholder="AWS access key">
                                </div>
                                <div class="mb-2">
                                    <label for="s3SecretKey" class="form-label">Secret Key</label>
                                    <input type="password" class="form-control" id="s3SecretKey" placeholder="AWS secret key" autocomplete="current-password">
                                </div>
                                <div class="mb-2">
                                    <label for="s3Prefix" class="form-label">Prefix (Optional)</label>
                                    <input type="text" class="form-control" id="s3Prefix" placeholder="e.g., folder/">
                                </div>
                            </div>

                            <div id="googleConfig" class="provider-config">
                                <h6>Google Cloud Storage Configuration</h6>
                                <div class="mb-2">
                                    <label for="gcsBucket" class="form-label">Bucket</label>
                                    <input type="text" class="form-control" id="gcsBucket" placeholder="Your GCS bucket name">
                                </div>
                                <div class="mb-2">
                                    <label for="gcsCredFile" class="form-label">Credential File Path</label>
                                    <input type="text" class="form-control" id="gcsCredFile" placeholder="Path to service account JSON file">
                                </div>
                                <div class="mb-2">
                                    <label for="gcsPrefix" class="form-label">Prefix (Optional)</label>
                                    <input type="text" class="form-control" id="gcsPrefix" placeholder="e.g., folder/">
                                </div>
                            </div>

                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="processFile" checked>
                                <label class="form-check-label" for="processFile">Process file after upload</label>
                            </div>

                            <button type="submit" class="btn btn-primary">Upload File</button>
                        </form>
                        
                        <!-- New processing status section -->
                        <div id="processingStatus" class="processing-status mt-3">
                            <h6>Real-Time File Processing Status</h6>
                            <div class="step-indicator">
                                <div class="step" id="step1">
                                    1
                                    <div class="step-label">Upload</div>
                                </div>
                                <div class="step-line" id="line1"></div>
                                <div class="step" id="step2">
                                    2
                                    <div class="step-label">Processing</div>
                                </div>
                                <div class="step-line" id="line2"></div>
                                <div class="step" id="step3">
                                    3
                                    <div class="step-label">Complete</div>
                                </div>
                            </div>
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div id="progressMessage" class="mb-2">Waiting for upload...</div>
                            
                            <!-- Speedometer display for upload/download speeds -->
                            <div class="speedometer-container mb-3">
                                <div class="speedometer">
                                    <div class="speedometer-title">Upload Speed</div>
                                    <div class="speedometer-dial">
                                        <div class="speedometer-needle" id="uploadSpeedNeedle"></div>
                                        <div class="speedometer-center"></div>
                                    </div>
                                    <div class="speedometer-value" id="uploadSpeedValue">0 <span class="speedometer-unit">KB/s</span></div>
                                </div>
                                
                                <div class="speedometer">
                                    <div class="speedometer-title">Download Speed</div>
                                    <div class="speedometer-dial">
                                        <div class="speedometer-needle" id="downloadSpeedNeedle"></div>
                                        <div class="speedometer-center"></div>
                                    </div>
                                    <div class="speedometer-value" id="downloadSpeedValue">0 <span class="speedometer-unit">KB/s</span></div>
                                </div>
                            </div>
                            
                            <div id="realTimeLog"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New LAN file transfer section -->
        <div class="row mb-4">
            <div class="col">
                <div class="card" id="lanSection">
                    <div class="card-header">
                        <h5>LAN File Transfer</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button id="discoverPeers" class="btn btn-outline-primary mb-3">Discover Peers on LAN</button>
                            <div id="peersList" class="mb-3">No peers found on the local network.</div>
                        </div>
                        <div id="transferStatus" class="mt-3" style="display: none;">
                            <h6>Transfer Status</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div id="transferMessage">Waiting for transfer to start...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>File List</h5>
                        <button id="refreshFiles" class="btn btn-outline-secondary btn-sm">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="listStorageType" class="form-label">Storage Provider</label>
                            <select class="form-select" id="listStorageType">
                                <option value="local" selected>Local Storage</option>
                                <option value="s3">Amazon S3</option>
                                <option value="google">Google Cloud Storage</option>
                            </select>
                        </div>

                        <div id="s3ListConfig" class="provider-config">
                            <h6>Amazon S3 Configuration</h6>
                            <div class="mb-2">
                                <label for="s3ListRegion" class="form-label">Region</label>
                                <input type="text" class="form-control" id="s3ListRegion" placeholder="e.g., us-east-1">
                            </div>
                            <div class="mb-2">
                                <label for="s3ListBucket" class="form-label">Bucket</label>
                                <input type="text" class="form-control" id="s3ListBucket" placeholder="Your S3 bucket name">
                            </div>
                            <div class="mb-2">
                                <label for="s3ListAccessKey" class="form-label">Access Key</label>
                                <input type="text" class="form-control" id="s3ListAccessKey" placeholder="AWS access key">
                            </div>
                            <div class="mb-2">
                                <label for="s3ListSecretKey" class="form-label">Secret Key</label>
                                <input type="password" class="form-control" id="s3ListSecretKey" placeholder="AWS secret key" autocomplete="current-password">
                            </div>
                            <div class="mb-2">
                                <label for="s3ListPrefix" class="form-label">Prefix (Optional)</label>
                                <input type="text" class="form-control" id="s3ListPrefix" placeholder="e.g., folder/">
                            </div>
                        </div>

                        <div id="googleListConfig" class="provider-config">
                            <h6>Google Cloud Storage Configuration</h6>
                            <div class="mb-2">
                                <label for="gcsListBucket" class="form-label">Bucket</label>
                                <input type="text" class="form-control" id="gcsListBucket" placeholder="Your GCS bucket name">
                            </div>
                            <div class="mb-2">
                                <label for="gcsListCredFile" class="form-label">Credential File Path</label>
                                <input type="text" class="form-control" id="gcsListCredFile" placeholder="Path to service account JSON file">
                            </div>
                            <div class="mb-2">
                                <label for="gcsListPrefix" class="form-label">Prefix (Optional)</label>
                                <input type="text" class="form-control" id="gcsListPrefix" placeholder="e.g., folder/">
                            </div>
                        </div>

                        <div class="text-end mb-2">
                            <button id="fetchFileList" class="btn btn-primary">List Files</button>
                        </div>

                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fileList">
                                <tr>
                                    <td colspan="4" class="text-center">No files to display</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <div class="card" id="filePreview">
                    <div class="card-header">
                        <h5 id="previewTitle">File Preview</h5>
                    </div>
                    <div class="card-body">
                        <div id="previewContent">
                            <div class="mb-3">
                                <h6>File Details</h6>
                                <table class="table table-sm">
                                    <tbody id="fileDetails"></tbody>
                                </table>
                            </div>

                            <div class="mb-3" id="previewContainer">
                                <h6>Preview</h6>
                                <div class="preview-container" id="previewData"></div>
                            </div>

                            <div id="processedInfo">
                                <h6>Processed Information</h6>
                                <table class="table table-sm">
                                    <tbody id="processedDetails"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // WebSocket connection management
        let ws = null;
        let wsConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;
        let reconnectTimeout = 1000; // Start with 1 second, will increase with backoff
        let heartbeatInterval = null;
        let lastMessageTimestamp = 0;
        let pendingMessages = []; // Store messages that couldn't be sent due to disconnection
        let clientNonce = generateNonce(); // Used to prevent replay attacks
        let serverTimeOffset = 0; // Time difference between client and server
        
        // Connect to WebSocket server
        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
                console.log('WebSocket connection already exists');
                return;
            }
            
            // Clean up any existing connection
            if (ws) {
                try {
                    ws.close();
                } catch (e) {
                    console.error('Error closing existing websocket:', e);
                }
                ws = null;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            
            // Add authentication token if available
            let wsUrl = `${protocol}//${window.location.host}/ws`;
            const authToken = localStorage.getItem('auth_token');
            
            // Only include the token if it exists and using secure protocol,
            // or if we're in a local development environment
            if (authToken && (protocol === 'wss:' || 
                window.location.hostname === 'localhost' || 
                window.location.hostname === '127.0.0.1')) {
                wsUrl += `?token=${encodeURIComponent(authToken)}`;
            }
            
            console.log(`Connecting to WebSocket: ${wsUrl}`);
            addLogMessage('Connecting to WebSocket server...', 'info');
            
            try {
                ws = new WebSocket(wsUrl);
                
                // Set a connection timeout
                const connectionTimeout = setTimeout(() => {
                    if (ws && ws.readyState !== WebSocket.OPEN) {
                        console.error('WebSocket connection timeout');
                        ws.close();
                        handleReconnect();
                    }
                }, 10000); // 10 second timeout
                
                // Connection opened
                ws.onopen = function() {
                    clearTimeout(connectionTimeout);
                    wsConnected = true;
                    console.log('WebSocket connection established');
                    addLogMessage('WebSocket connection established', 'success');
                    
                    // Reset reconnection state on successful connection
                    reconnectAttempts = 0;
                    reconnectTimeout = 1000;
                    
                    // Start sending heartbeats to keep connection alive
                    startHeartbeat();
                    
                    // Send any pending messages that couldn't be sent while disconnected
                    if (pendingMessages.length > 0) {
                        console.log(`Sending ${pendingMessages.length} pending messages`);
                        pendingMessages.forEach(msg => {
                            sendWebSocketMessage(msg.type, msg.taskId, msg.content);
                        });
                        pendingMessages = [];
                    }
                };
                
                // Listen for messages
                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        
                        // Validate message structure to prevent security issues
                        if (!message || !message.type || typeof message.type !== 'string') {
                            console.error('Invalid message format received');
                            return;
                        }
                        
                        // Update the last message timestamp
                        lastMessageTimestamp = Date.now();
                        
                        // Handle different message types
                        switch (message.type) {
                            case 'connected':
                                // Store server time for offset calculation
                                if (message.content && message.content.serverTime) {
                                    serverTimeOffset = message.content.serverTime - Date.now();
                                    console.log(`Server time offset: ${serverTimeOffset}ms`);
                                }
                                break;
                            
                            case 'error':
                                console.error('Server error:', message.content);
                                addLogMessage(`Server error: ${message.content ? message.content.error || 'Unknown error' : 'Unknown error'}`, 'error');
                                break;
                                
                            case 'pong':
                                // Heartbeat response, no need to handle specially
                                break;
                                
                            case 'shutdown':
                                addLogMessage('Server is shutting down. Disconnecting...', 'warning');
                                // Don't attempt to reconnect on clean shutdown
                                wsConnected = false;
                                ws.close();
                                ws = null;
                                stopHeartbeat();
                                break;
                                
                            default:
                                // Process other message types
                                handleWebSocketMessage(message);
                        }
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error, event.data);
                        addLogMessage('Error processing server message', 'error');
                    }
                };
                
                // Connection closed
                ws.onclose = function(event) {
                    clearTimeout(connectionTimeout);
                    wsConnected = false;
                    stopHeartbeat();
                    
                    console.log(`WebSocket connection closed: ${event.code} - ${event.reason}`);
                    
                    // Don't attempt to reconnect on authentication failures or clean shutdowns
                    if (event.code === 1008 || // Policy violation (auth failure)
                        event.code === 1000) { // Normal closure (clean shutdown)
                        addLogMessage(`WebSocket connection closed: ${event.reason || 'Server disconnected'}`, 'warning');
                        return;
                    }
                    
                    handleReconnect();
                };
                
                // Connection error
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    addLogMessage('WebSocket connection error', 'error');
                    // Error handling will be done by onclose
                };
            } catch (error) {
                console.error('Error creating WebSocket connection:', error);
                addLogMessage('Failed to create WebSocket connection', 'error');
                handleReconnect();
            }
        }
        
        // Handle reconnection with exponential backoff
        function handleReconnect() {
            if (reconnectAttempts >= maxReconnectAttempts) {
                console.log('Maximum reconnection attempts reached');
                addLogMessage('Failed to connect to server after multiple attempts', 'error');
                return;
            }
            
            reconnectAttempts++;
            
            // Exponential backoff with jitter
            const jitter = Math.random() * 0.5 + 0.75; // Random between 0.75 and 1.25
            const delay = Math.min(reconnectTimeout * jitter, 30000); // Cap at 30 seconds
            
            console.log(`Reconnecting in ${Math.round(delay / 1000)}s (attempt ${reconnectAttempts} of ${maxReconnectAttempts})`);
            addLogMessage(`Reconnecting in ${Math.round(delay / 1000)} seconds...`, 'info');
            
            setTimeout(() => {
                connectWebSocket();
            }, delay);
            
            // Increase backoff for next attempt
            reconnectTimeout = Math.min(reconnectTimeout * 2, 30000);
        }
        
        // Start sending heartbeats
        function startHeartbeat() {
            stopHeartbeat(); // Clean up any existing interval
            
            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendWebSocketMessage('ping');
                    
                    // Check if we haven't received any message for a while
                    if (lastMessageTimestamp > 0 && Date.now() - lastMessageTimestamp > 90000) {
                        console.warn('No messages received for 90 seconds, reconnecting...');
                        ws.close();
                        connectWebSocket();
                    }
                } else {
                    // WebSocket is not open, stop heartbeats
                    stopHeartbeat();
                }
            }, 30000); // Send heartbeat every 30 seconds
        }
        
        // Stop sending heartbeats
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }
        
        // Send a message to the WebSocket server
        function sendWebSocketMessage(type, taskId = null, content = null) {
            const message = {
                type: type,
                timestamp: Date.now() + serverTimeOffset, // Add server time offset
                nonce: generateNonce() // Add a unique nonce to prevent replay attacks
            };
            
            if (taskId) {
                message.taskId = taskId;
            }
            
            if (content) {
                message.content = content;
            }
            
            // Check if we're connected
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    ws.send(JSON.stringify(message));
                    return true;
                } catch (error) {
                    console.error('Error sending WebSocket message:', error);
                    addLogMessage('Error sending message to server', 'error');
                    return false;
                }
            } else {
                // Store message to send when reconnected
                console.log('WebSocket not connected, queueing message:', message);
                pendingMessages.push({
                    type: type,
                    taskId: taskId,
                    content: content
                });
                
                // Try to reconnect
                if (!ws || ws.readyState === WebSocket.CLOSED) {
                    connectWebSocket();
                }
                
                return false;
            }
        }
        
        // Subscribe to a task's updates
        function subscribeToTask(taskId) {
            if (!taskId) return false;
            return sendWebSocketMessage('subscribe', taskId);
        }
        
        // Unsubscribe from a task's updates
        function unsubscribeFromTask(taskId) {
            if (!taskId) return false;
            return sendWebSocketMessage('unsubscribe', taskId);
        }
        
        // Generate a unique nonce for message security
        function generateNonce() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // Handle WebSocket messages from the server
        function handleWebSocketMessage(message) {
            console.log('Received WebSocket message:', message);
            
            // Process message based on type
            switch(message.type) {
                case 'authenticated':
                    handleAuthenticationResponse(message);
                    break;
                    
                case 'processing_started':
                    if (message.content && message.content.file) {
                        addLogMessage(`Started processing ${message.content.file.Name}`, 'info');
                        
                        // Update UI to show processing has started
                        const progressBar = document.querySelector('.progress-bar');
                        if (progressBar && progressBar.dataset.taskId === message.taskId) {
                            document.getElementById('progressMessage').textContent = 'Processing started...';
                        }
                    }
                    break;
                    
                case 'processing_progress':
                    if (message.content && message.content.progress) {
                        const progress = message.content.progress;
                        const fileName = message.content.file ? message.content.file.Name : '';
                        
                        addLogMessage(`Processing progress: ${progress}% - ${fileName}`, 'info');
                        
                        // Update progress bar (scale from 33% to 90%)
                        updateTaskProgress(message.taskId, progress, `Processing: ${progress}%`);
                    }
                    break;
                    
                case 'processing_completed':
                    if (message.content && message.content.file) {
                        const fileName = message.content.file.Name;
                        addLogMessage(`Completed processing ${fileName}`, 'success');
                        
                        // Create download link for the processed file
                        const downloadUrl = `/api/download?id=${message.content.file.StorageID}&storageType=${message.content.file.StorageType}`;
                        
                        // Mark task as complete in UI
                        markTaskComplete(message.taskId, downloadUrl, message.content);
                    }
                    break;
                    
                case 'processing_failed':
                    if (message.content && message.content.error) {
                        addLogMessage(`Processing error: ${message.content.error}`, 'error');
                        
                        // Update UI for failed task
                        if (message.taskId && message.content.file) {
                            markTaskFailed(message.taskId, message.content.error);
                        }
                    }
                    break;
                    
                case 'serverStatus':
                    updateServerStatus(message.content);
                    break;
                    
                default:
                    console.log('Received other message type:', message.type);
            }
        }
        
        // Connect WebSocket when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check OS and show appropriate admin alert
            const isWindows = navigator.platform.toLowerCase().includes('win');
            if (!isWindows) {
                // Show Linux admin alert
                document.getElementById('linuxAdminAlert').style.display = 'block';
            } else {
                // Remove admin alert row for Windows
                document.getElementById('adminAlertRow').style.display = 'none';
            }
            
            // Initialize without authentication
            hideAuthElements();
            
            // Connect WebSocket
            connectWebSocket();
            
            // Show/hide storage provider config based on selection
            document.getElementById('storageType').addEventListener('change', function() {
                document.querySelectorAll('.provider-config').forEach(config => {
                    config.style.display = 'none';
                });
                
                if (this.value === 's3') {
                    document.getElementById('s3Config').style.display = 'block';
                } else if (this.value === 'google') {
                    document.getElementById('googleConfig').style.display = 'block';
                }
            });
            
            document.getElementById('listStorageType').addEventListener('change', function() {
                document.querySelectorAll('#s3ListConfig, #googleListConfig').forEach(config => {
                    config.style.display = 'none';
                });
                
                if (this.value === 's3') {
                    document.getElementById('s3ListConfig').style.display = 'block';
                } else if (this.value === 'google') {
                    document.getElementById('googleListConfig').style.display = 'block';
                }
            });
            
            // Initialize fetch provider status
            fetchProviderStatus();
            
            // Initialize file upload form
            initFileUpload();
            
            // Initialize file listing
            document.getElementById('fetchFileList').addEventListener('click', fetchFileList);
            document.getElementById('refreshFiles').addEventListener('click', fetchFileList);
            
            // Initialize LAN discovery
            document.getElementById('discoverPeers').addEventListener('click', discoverPeers);
            document.getElementById('lanSection').style.display = 'block';
        });
        
        // Fetch storage provider status
        function fetchProviderStatus() {
            fetch('/api/storage/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        displayProviderStatus(data.data);
                    } else {
                        console.error('Failed to fetch provider status:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching provider status:', error);
                });
        }
        
        // Display storage provider status
        function displayProviderStatus(providers) {
            // ...existing provider status code...
        }
        
        // Rest of existing functions...
        
        // Dummy checkAuthStatus function - Authentication disabled
        function checkAuthStatus() {
            console.log('Authentication disabled');
            return false;
        }

        // Hide authentication-related UI elements
        function hideAuthElements() {
            // Hide authentication UI
            document.getElementById('userAuthSection').style.display = 'none';
            document.getElementById('userProfileCard').style.display = 'none';
            document.getElementById('cloudConfigCard').style.display = 'none';
        }

        // Dummy authentication response handler (prevents errors)
        function handleAuthenticationResponse(message) {
            console.log('Authentication response received (disabled):', message);
        }

        // Dummy login function (prevents errors)
        function login() {
            console.log('Login functionality disabled');
        }

        // Dummy logout function (prevents errors)
        function logout() {
            console.log('Logout functionality disabled');
        }

        // Dummy saveCloudConfig function (prevents errors)
        function saveCloudConfig(provider, config) {
            console.log('Cloud config save disabled');
        }

        // Initialize the file upload functionality
        function initFileUpload() {
            // Speed tracking variables
            let uploadStartTime = 0;
            let uploadedBytes = 0;
            let lastUploadedBytes = 0;
            let lastUploadSpeedUpdateTime = 0;
            const speedUpdateInterval = 500; // Update speed every 500ms
            
            // Handle file upload form submission
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                if (!file) {
                    addLogMessage('Please select a file to upload', 'error');
                    return;
                }
                
                // Get storage provider and config
                const storageType = document.getElementById('storageType').value;
                const processFile = document.getElementById('processFile').checked;
                
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                formData.append('storageType', storageType);
                formData.append('processFile', processFile);
                
                // Add provider-specific config
                if (storageType === 's3') {
                    formData.append('region', document.getElementById('s3Region').value);
                    formData.append('bucket', document.getElementById('s3Bucket').value);
                    formData.append('accessKey', document.getElementById('s3AccessKey').value);
                    formData.append('secretKey', document.getElementById('s3SecretKey').value);
                    formData.append('prefix', document.getElementById('s3Prefix').value);
                } else if (storageType === 'google') {
                    formData.append('bucket', document.getElementById('gcsBucket').value);
                    formData.append('credentialFile', document.getElementById('gcsCredFile').value);
                    formData.append('prefix', document.getElementById('gcsPrefix').value);
                }
                
                // Show processing status UI
                document.getElementById('processingStatus').style.display = 'block';
                document.getElementById('step1').className = 'step active';
                document.getElementById('progressMessage').textContent = 'Uploading file...';
                document.querySelector('.progress-bar').style.width = '0%';
                document.querySelector('.progress-bar').textContent = '0%';
                
                // Reset speed tracking
                uploadStartTime = Date.now();
                uploadedBytes = 0;
                lastUploadedBytes = 0;
                lastUploadSpeedUpdateTime = uploadStartTime;
                updateSpeedometer('upload', 0);
                updateSpeedometer('download', 0);
                
                // Create an XMLHttpRequest to track upload progress
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/upload', true);
                
                // Track upload progress
                xhr.upload.onprogress = function(event) {
                    if (event.lengthComputable) {
                        const now = Date.now();
                        uploadedBytes = event.loaded;
                        
                        // Calculate upload percentage
                        const percentComplete = Math.round((event.loaded / event.total) * 33); // 0-33% for upload phase
                        document.querySelector('.progress-bar').style.width = `${percentComplete}%`;
                        document.querySelector('.progress-bar').textContent = `${percentComplete}%`;
                        
                        // Update upload speed periodically
                        if (now - lastUploadSpeedUpdateTime >= speedUpdateInterval) {
                            // Calculate speed in bytes per second
                            const timeDiff = (now - lastUploadSpeedUpdateTime) / 1000; // Convert ms to seconds
                            const bytesDiff = uploadedBytes - lastUploadedBytes;
                            const speed = bytesDiff / timeDiff; // Bytes per second
                            
                            // Update speedometer
                            updateSpeedometer('upload', speed);
                            
                            // Update tracking variables
                            lastUploadedBytes = uploadedBytes;
                            lastUploadSpeedUpdateTime = now;
                        }
                    }
                };
                
                // Handle upload completion
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            
                            if (data.success) {
                                // Calculate final average upload speed
                                const totalTime = (Date.now() - uploadStartTime) / 1000; // seconds
                                const avgSpeed = file.size / totalTime; // bytes per second
                                updateSpeedometer('upload', avgSpeed);
                                
                                addLogMessage(`File uploaded successfully: ${file.name}`, 'success');
                                document.getElementById('step1').className = 'step completed';
                                document.getElementById('line1').className = 'step-line active';
                                document.getElementById('step2').className = 'step active';
                                document.getElementById('progressMessage').textContent = 'File uploaded. Processing...';
                                document.querySelector('.progress-bar').style.width = '33%';
                                document.querySelector('.progress-bar').textContent = '33%';
                                
                                // Subscribe to task updates via WebSocket
                                if (data.taskId) {
                                    subscribeToTask(data.taskId);
                                }
                                
                                // Store the task ID in the UI
                                const progressBar = document.querySelector('.progress-bar');
                                progressBar.dataset.taskId = data.taskId;
                            } else {
                                addLogMessage(`Upload failed: ${data.error || 'Unknown error'}`, 'error');
                                document.getElementById('progressMessage').textContent = `Upload failed: ${data.error || 'Unknown error'}`;
                                updateSpeedometer('upload', 0);
                            }
                        } catch (error) {
                            console.error('Error parsing response:', error);
                            addLogMessage(`Upload error: Invalid server response`, 'error');
                            document.getElementById('progressMessage').textContent = 'Upload error: Invalid server response';
                            updateSpeedometer('upload', 0);
                        }
                    } else {
                        addLogMessage(`Upload failed: Server returned status ${xhr.status}`, 'error');
                        document.getElementById('progressMessage').textContent = `Upload failed: Server returned status ${xhr.status}`;
                        updateSpeedometer('upload', 0);
                    }
                };
                
                // Handle upload errors
                xhr.onerror = function() {
                    console.error('Upload network error');
                    addLogMessage('Upload error: Network error', 'error');
                    document.getElementById('progressMessage').textContent = 'Upload error: Network error';
                    updateSpeedometer('upload', 0);
                };
                
                // Send the request
                xhr.send(formData);
            });
            
            // Initialize download progress tracking for links created after completed uploads
            document.addEventListener('click', function(e) {
                if (e.target && e.target.tagName === 'A' && e.target.getAttribute('href') && 
                    e.target.getAttribute('href').startsWith('/download/')) {
                    
                    // Track downloads on links created after upload
                    trackDownload(e.target);
                }
            }, true);
        }
        
        // Update speedometer display
        function updateSpeedometer(type, bytesPerSecond) {
            // Convert bytes per second to appropriate unit
            let speedValue;
            let speedUnit;
            
            if (bytesPerSecond < 1024) {
                speedValue = bytesPerSecond;
                speedUnit = 'B/s';
            } else if (bytesPerSecond < 1024 * 1024) {
                speedValue = bytesPerSecond / 1024;
                speedUnit = 'KB/s';
            } else if (bytesPerSecond < 1024 * 1024 * 1024) {
                speedValue = bytesPerSecond / (1024 * 1024);
                speedUnit = 'MB/s';
            } else {
                speedValue = bytesPerSecond / (1024 * 1024 * 1024);
                speedUnit = 'GB/s';
            }
            
            // Round to 1 decimal place
            speedValue = Math.round(speedValue * 10) / 10;
            
            // Get speedometer elements
            const needle = document.getElementById(`${type}SpeedNeedle`);
            const valueDisplay = document.getElementById(`${type}SpeedValue`);
            
            if (needle && valueDisplay) {
                // Update the value display
                valueDisplay.innerHTML = `${speedValue} <span class="speedometer-unit">${speedUnit}</span>`;
                
                // Calculate needle rotation (0 degrees = 0 KB/s, 180 degrees = 10 MB/s or more)
                // Normalize the speed to a 0-10 scale where 10 represents 10 MB/s (10,485,760 bytes/s)
                const maxSpeed = 10 * 1024 * 1024; // 10 MB/s
                const normalizedSpeed = Math.min(bytesPerSecond / maxSpeed * 10, 10);
                
                // Convert to degrees (0-180)
                const degrees = normalizedSpeed * 18;
                
                // Set needle rotation
                needle.style.transform = `rotate(${degrees}deg)`;
            }
        }
        
        // Track download progress
        function trackDownload(linkElement) {
            // We can't directly track native browser downloads
            // But we can simulate download speed with an XHR request and abort it after getting progress data
            
            const url = linkElement.getAttribute('href');
            const fileName = url.split('/').pop();
            
            // Start download monitoring
            addLogMessage(`Starting download of ${fileName}...`, 'info');
            
            let downloadStartTime = Date.now();
            let downloadedBytes = 0;
            let lastDownloadedBytes = 0;
            let lastSpeedUpdateTime = downloadStartTime;
            
            // Create a request to track download progress
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'blob';
            
            // Track download progress
            xhr.onprogress = function(event) {
                if (event.lengthComputable) {
                    const now = Date.now();
                    downloadedBytes = event.loaded;
                    
                    // Update download speed periodically
                    if (now - lastSpeedUpdateTime >= 500) { // Update every 500ms
                        // Calculate speed in bytes per second
                        const timeDiff = (now - lastSpeedUpdateTime) / 1000;
                        const bytesDiff = downloadedBytes - lastDownloadedBytes;
                        const speed = bytesDiff / timeDiff;
                        
                        // Update speedometer
                        updateSpeedometer('download', speed);
                        
                        // Update tracking variables
                        lastDownloadedBytes = downloadedBytes;
                        lastSpeedUpdateTime = now;
                    }
                    
                    // If we've tracked enough of the download, abort the request
                    // This is to prevent downloading the entire file twice
                    if (event.loaded > 1024 * 1024 || (event.loaded / event.total) > 0.1) {
                        xhr.abort();
                        
                        // Let user know we're just tracking, not interfering with the actual download
                        addLogMessage('Download speed monitoring active...', 'info');
                    }
                }
            };
            
            xhr.onload = function() {
                // Calculate final average download speed
                const totalTime = (Date.now() - downloadStartTime) / 1000;
                const avgSpeed = downloadedBytes / totalTime;
                updateSpeedometer('download', avgSpeed);
            };
            
            xhr.onerror = function() {
                console.error('Error tracking download');
                updateSpeedometer('download', 0);
            };
            
            xhr.send();
        }
        
        // Update task progress in the UI
        function updateTaskProgress(taskId, progress, status) {
            // Update progress UI if this is the current task
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar && progressBar.dataset.taskId === taskId) {
                // Scale progress to 33-66% (upload was 0-33%, completion will be 66-100%)
                const scaledProgress = 33 + (progress / 100 * 33);
                progressBar.style.width = `${scaledProgress}%`;
                progressBar.textContent = `${Math.round(scaledProgress)}%`;
                
                if (status) {
                    document.getElementById('progressMessage').textContent = status;
                }
            }
            
            // Add log message
            addLogMessage(`Processing progress: ${progress}% - ${status || ''}`, 'info');
        }
        
        // Mark a task as completed with results
        function markTaskComplete(taskId, downloadUrl, resultData) {
            // Update UI if this is the current task
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar && progressBar.dataset.taskId === taskId) {
                document.getElementById('step2').className = 'step completed';
                document.getElementById('line2').className = 'step-line active';
                document.getElementById('step3').className = 'step active';
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                document.getElementById('progressMessage').textContent = 'Processing complete!';
                
                // Add a link to the result
                if (downloadUrl) {
                    const resultContainer = document.createElement('div');
                    resultContainer.className = 'mt-3 text-center';
                    
                    const resultLink = document.createElement('a');
                    resultLink.href = downloadUrl;
                    resultLink.className = 'btn btn-success';
                    resultLink.target = '_blank';
                    resultLink.textContent = 'Download Processed File';
                    
                    resultContainer.appendChild(resultLink);
                    
                    // Add result container only if it doesn't exist yet
                    const existingResult = document.querySelector('#processingStatus .mt-3.text-center');
                    if (!existingResult) {
                        document.getElementById('processingStatus').appendChild(resultContainer);
                    }
                }
                
                // File is saved, mark the step as complete
                setTimeout(() => {
                    document.getElementById('step3').className = 'step completed';
                }, 1000);
                
                // Unsubscribe from the task updates
                unsubscribeFromTask(taskId);
            }
        }
        
        // Mark a task as failed
        function markTaskFailed(taskId, errorMessage) {
            // Update UI if this is the current task
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar && progressBar.dataset.taskId === taskId) {
                document.getElementById('step2').className = 'step';
                progressBar.className = 'progress-bar bg-danger';
                document.getElementById('progressMessage').textContent = `Processing failed: ${errorMessage}`;
            }
            
            // Add error to log
            addLogMessage(`Processing failed: ${errorMessage}`, 'error');
            
            // Unsubscribe from the task updates
            unsubscribeFromTask(taskId);
        }
        
        // Add a message to the real-time log
        function addLogMessage(message, type = 'info') {
            const logElement = document.getElementById('realTimeLog');
            if (!logElement) return;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${timeStr}]</span> ${message}`;
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Discover peers on the LAN
        function discoverPeers() {
            document.getElementById('discoverPeers').disabled = true;
            document.getElementById('peersList').innerHTML = 'Searching for peers...';
            
            fetch('/api/lan/discover')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('discoverPeers').disabled = false;
                    
                    if (data.success && data.peers && data.peers.length > 0) {
                        const peersList = document.getElementById('peersList');
                        peersList.innerHTML = '';
                        
                        data.peers.forEach(peer => {
                            const peerCard = document.createElement('div');
                            peerCard.className = 'card mb-2';
                            peerCard.innerHTML = `
                                <div class="card-body">
                                    <h6 class="card-title">${peer.name || 'Unknown Device'}</h6>
                                    <p class="card-text">IP: ${peer.ip} - Port: ${peer.port}</p>
                                    <button class="btn btn-sm btn-primary connect-peer" 
                                            data-ip="${peer.ip}" 
                                            data-port="${peer.port}" 
                                            data-id="${peer.id}">
                                        Connect
                                    </button>
                                </div>
                            `;
                            peersList.appendChild(peerCard);
                            
                            // Add click handler for the connect button
                            peerCard.querySelector('.connect-peer').addEventListener('click', function() {
                                connectToPeer(this.getAttribute('data-ip'), 
                                            this.getAttribute('data-port'),
                                            this.getAttribute('data-id'));
                            });
                        });
                    } else {
                        document.getElementById('peersList').innerHTML = 
                            'No peers found on the local network. Make sure other devices are running the app.';
                    }
                })
                .catch(error => {
                    document.getElementById('discoverPeers').disabled = false;
                    document.getElementById('peersList').innerHTML = 
                        `Error discovering peers: ${error.message}`;
                    console.error('Error discovering peers:', error);
                });
        }
        
        // Connect to a peer
        function connectToPeer(ip, port, id) {
            const transferStatus = document.getElementById('transferStatus');
            transferStatus.style.display = 'block';
            
            const transferMessage = document.getElementById('transferMessage');
            transferMessage.textContent = `Connecting to peer: ${ip}:${port}`;
            
            const progressBar = transferStatus.querySelector('.progress-bar');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            // Simulate connection and speed
            setTimeout(() => {
                transferMessage.textContent = 'Connected! Starting data transfer...';
                
                // Simulate download speed
                const randomSpeed = (Math.random() * 8 + 2) * 1024 * 1024; // 2-10 MB/s
                updateSpeedometer('download', randomSpeed);
                
                // Simulate progress updates
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 5 + 1;
                    if (progress > 100) progress = 100;
                    
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        transferMessage.textContent = 'Transfer complete!';
                        setTimeout(() => {
                            transferStatus.style.display = 'none';
                            updateSpeedometer('download', 0);
                        }, 3000);
                    } else {
                        transferMessage.textContent = `Transferring... ${Math.round(progress)}%`;
                    }
                }, 300);
            }, 1000);
        }
    </script>
</body>
</html>